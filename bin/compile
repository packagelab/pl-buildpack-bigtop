#!/bin/bash

# fail fast
set -o errexit
set -o nounset
set -o pipefail

usage() {
  echo "compile: usage: compile BUILD_DIR CACHE_DIR"
}

indent() {
  local c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *) sed -u "$c";;
  esac
}

main() {
  case $# in
    2) :;;
    *) usage >&2; exit 2;;
  esac

  local build_dir="$1"
  local cache_dir="$2"

  echo "-----> Installing gradle"
  cd $build_dir >/dev/null 2>&1
  curl -fsLS -o /tmp/gradle-2.1-bin.zip https://services.gradle.org/distributions/gradle-2.1-bin.zip
  mkdir -p $build_dir/.local
  unzip -d $build_dir/.local /tmp/gradle-2.1-bin.zip
  mv $build_dir/.local/gradle-2.1 $build_dir/.local/gradle
  cd - >/dev/null 2>&1  

  echo "-----> Creating ivysettings.xml"
  mkdir -p $HOME/.ivy2
  cat <<EOT >$HOME/.ivy2/ivysettings.xml
<ivysettings>
  <caches defaultCacheDir="$cache_dir/ivy2/cache"/>
</ivysettings>
EOT

  export GRADLE_USER_HOME=$cache_dir/gradle
  export MAVEN_OPTS=-Dmaven.repo.local=$cache_dir/m2/repository
  export PATH=$build_dir/.local/gradle/bin:$PATH

  echo "-----> Building packages"
  cd $build_dir >/dev/null 2>&1
  gradle zookeeper-deb bigtop-utils-deb whirr-deb bigtop-tomcat-deb 2>&1 | indent
  cd - >/dev/null 2>&1
}

case "$0" in
  "$BASH_SOURCE") main "$@";;
esac
